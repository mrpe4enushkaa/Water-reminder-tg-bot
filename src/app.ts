import TelegramBot from "node-telegram-bot-api";
import Redis from "ioredis";
import { ConfigService } from "./config/config.service";
import { RedisService } from "./databases/redis/redis.service";
import { Command } from "./commands/abstract.command";
import { OnMessage } from "./commands/command.on-message";
import { CallbackQueryCommand } from "./commands/command.callback-query";
import { StartCommand } from "./commands/command.start";
import { ParametersCommand } from "./commands/command.parameters";
import { DrinkWaterCommand } from "./commands/command.drink-water";
import { MessagesIdsTuple } from "./models/messages-ids.type";
import { WaitingStates } from "./models/waiting-states.type";
import { UserProvidedData } from "./models/user-provided-data.type";
import { HelpCommand } from "./commands/command.help";
import { TimeCommand } from "./commands/command.time";
import { ContinueCommand } from "./commands/command.continue";
import { StopCommand } from "./commands/command.stop";

class Bot {
    private bot: TelegramBot;
    private commands: Command[] = [];
    private redis: RedisService;

    private waitingStates: Map<number, WaitingStates> = new Map<number, WaitingStates>;
    private lastMessages: Map<number, MessagesIdsTuple> = new Map<number, MessagesIdsTuple>;
    private notificationQueue: Set<number> = new Set();
    private editUserParameters: Set<number> = new Set();
    private userProvidedData: Map<number, UserProvidedData> = new Map<number, UserProvidedData>;

    constructor(private readonly token: string) {
        this.bot = new TelegramBot(this.token, { polling: true });
        this.redis = new RedisService();
        this.redis.handle();
    }

    private setCommands(): void {
        this.bot.setMyCommands([
            { command: "/start", description: "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É" },
            { command: "/add_parameters", description: "‚ûï –í–≤–µ—Å—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–≤–µ—Å –∏ —Ç.–¥.)" },
            { command: "/edit_parameters", description: "‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–Ω–µ–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã" },
            { command: "/delete_parameters", description: "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ —Å–µ–±–µ" },
            { command: "/info_parameters", description: "üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã" },
            { command: "/drink", description: "üíß –û—Ç–º–µ—Ç–∏—Ç—å, —á—Ç–æ –≤—ã –≤—ã–ø–∏–ª–∏ –≤–æ–¥—É" },
            { command: "/help", description: "‚ÑπÔ∏è –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞" },
            { command: "/time", description: "‚è≥ –£–∑–Ω–∞—Ç—å, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ" },
            { command: "/continue", description: "üîî –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –≤–æ–¥–µ" },
            { command: "/stop", description: "üîï –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è" },
            // { command: "/change_language", description: "üåê –°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫ –±–æ—Ç–∞" },
        ], {
            language_code: "ru"
        });
    }

    private registerCommands(): void {
        this.commands = [
            new OnMessage(this.bot, this.waitingStates, this.lastMessages, this.notificationQueue, this.editUserParameters, this.userProvidedData, this.redis),
            new CallbackQueryCommand(this.bot, this.waitingStates, this.lastMessages, this.notificationQueue, this.editUserParameters, this.userProvidedData, this.redis),
            new StartCommand(this.bot, this.waitingStates, this.lastMessages, this.notificationQueue, this.editUserParameters, this.userProvidedData, this.redis),
            new ParametersCommand(this.bot, this.waitingStates, this.lastMessages, this.notificationQueue, this.editUserParameters, this.userProvidedData, this.redis),
            new DrinkWaterCommand(this.bot, this.waitingStates, this.lastMessages, this.notificationQueue, this.editUserParameters, this.userProvidedData, this.redis),
            new HelpCommand(this.bot, this.waitingStates, this.lastMessages, this.notificationQueue, this.editUserParameters, this.userProvidedData, this.redis),
            new TimeCommand(this.bot, this.waitingStates, this.lastMessages, this.notificationQueue, this.editUserParameters, this.userProvidedData, this.redis),
            new ContinueCommand(this.bot, this.waitingStates, this.lastMessages, this.notificationQueue, this.editUserParameters, this.userProvidedData, this.redis),
            new StopCommand(this.bot, this.waitingStates, this.lastMessages, this.notificationQueue, this.editUserParameters, this.userProvidedData, this.redis),
        ];

        for (const command of this.commands) {
            command.handle();
        }
    }

    public init(): void {
        this.setCommands();
        this.registerCommands();
    }
}

const config = new ConfigService();

const bot = new Bot(config.get("BOT_TOKEN"));
bot.init();